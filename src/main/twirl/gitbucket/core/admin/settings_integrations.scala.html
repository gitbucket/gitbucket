@(info: Option[Any])(implicit context: gitbucket.core.controller.Context)
@import gitbucket.core.util.DatabaseConfig
<!--====================================================================-->
<!-- Services -->
<!--====================================================================-->
<h5>Services</h5>
<fieldset>
  <div class="form-check">
    <input type="checkbox" class="form-check-input" id="gravatar" name="gravatar"@if(context.settings.gravatar){ checked}/>
    <label class="form-check-label" for="gravatar">Use Gravatar for profile images</label>
  </div>
</fieldset>
<!--====================================================================-->
<!-- SSH access -->
<!--====================================================================-->
<hr>
<h5>SSH access</h5>
<fieldset>
  <div class="form-check">
    <input type="checkbox" class="form-check-input" id="sshEnabled" name="ssh.enabled"@if(context.settings.ssh.enabled){ checked}/>
    <label class="form-check-label" for="sshEnabled">Enable SSH access to git repository</label>
    <span class="text-muted"> (Both SSH host and Base URL are required if SSH access is enabled)</span>
  </div>
</fieldset>
<div class="ssh">
  <div class="form-group row">
    <label class="col-md-2 col-form-label" for="sshHost">SSH host</label>
    <div class="col-md-10">
      <input type="text" id="sshHost" name="ssh.host" class="form-control" value="@context.settings.ssh.sshHost"/>
      <span id="error-ssh_host" class="error text-danger"></span>
    </div>
  </div>
  <div class="form-group row">
    <label class="col-md-2 col-form-label" for="sshPort">SSH port</label>
    <div class="col-md-10">
      <input type="text" id="sshPort" name="ssh.port" class="form-control" value="@context.settings.ssh.sshPort"/>
      <span id="error-ssh_port" class="error text-danger"></span>
    </div>
  </div>
</div>
<!--====================================================================-->
<!-- Communication email -->
<!--====================================================================-->
<hr>
<h5>Communication</h5>
<fieldset>
  <div class="form-check">
    <input type="checkbox" class="form-check-input" id="useSMTP" name="useSMTP" @if(context.settings.useSMTP){ checked}/>
    <label class="form-check-label" for="useSMTP">SMTP</label>
    <span class="text-muted"> (Enable notification as well as SMTP configuration if you want to send notification email too)</span>
  </div>
</fieldset>
<div class="useSMTP">
  <div class="form-group row">
    <label class="col-md-2 col-form-label" for="smtpHost">SMTP host</label>
    <div class="col-md-10">
      <input type="text" id="smtpHost" name="smtp.host" class="form-control" value="@context.settings.smtp.map(_.host)"/>
      <span id="error-smtp_host" class="error text-danger"></span>
    </div>
  </div>
  <div class="form-group row">
    <label class="col-md-2 col-form-label" for="smtpPort">SMTP port</label>
    <div class="col-md-10">
      <input type="text" id="smtpPort" name="smtp.port" class="form-control input-mini" value="@context.settings.smtp.map(_.port)"/>
      <span id="error-smtp_port" class="error text-danger"></span>
    </div>
  </div>
  <div class="form-group row">
    <label class="col-md-2 col-form-label" for="smtpUser">SMTP user</label>
    <div class="col-md-10">
      <input type="text" id="smtpUser" name="smtp.user" class="form-control" value="@context.settings.smtp.map(_.user)"/>
    </div>
  </div>
  <div class="form-group row">
    <label class="col-md-2 col-form-label" for="smtpPassword">SMTP password</label>
    <div class="col-md-10">
      <input type="password" id="smtpPassword" name="smtp.password" class="form-control" value="@context.settings.smtp.map(_.password)"/>
    </div>
  </div>
  <div class="form-group row">
    <label class="col-md-2 col-form-label" for="smtpSsl">Enable SSL</label>
    <div class="col-md-10">
      <input type="checkbox" id="smtpSsl" name="smtp.ssl"@if(context.settings.smtp.flatMap(_.ssl).getOrElse(false)){ checked}/>
    </div>
  </div>
  <div class="form-group row">
    <label class="col-md-2 col-form-label" for="smtpStarttls">Enable STARTTLS</label>
    <div class="col-md-10">
      <input type="checkbox" id="smtpStarttls" name="smtp.starttls"@if(context.settings.smtp.flatMap(_.starttls).getOrElse(false)){ checked}/>
    </div>
  </div>
  <div class="form-group row">
    <label class="col-md-2 col-form-label" for="fromAddress">FROM address</label>
    <div class="col-md-10">
      <input type="text" id="fromAddress" name="smtp.fromAddress" class="form-control" value="@context.settings.smtp.map(_.fromAddress)"/>
    </div>
  </div>
  <div class="form-group row">
    <label class="col-md-2 col-form-label" for="fromName">FROM name</label>
    <div class="col-md-10">
      <input type="text" id="fromName" name="smtp.fromName" class="form-control" value="@context.settings.smtp.map(_.fromName)"/>
    </div>
  </div>
  <div class="row">
    <div class="col">
      <div class="float-right form-inline">
        <div class="form-group">
          <label for="testAddress">Send test mail to:</label>
          <input type="text" class="form-control form-control-sm mx-sm-3" id="testAddress" size="30"/>
          <input type="button" class="btn btn-default btn-sm" id="sendTestMail" value="Send"/>
        </div>
      </div>
    </div>
  </div>
</div>
<!--====================================================================-->
<!-- Notification email -->
<!--====================================================================-->
<hr>
<h5>Notifications</h5>
<fieldset>
  <div class="form-check">
    <input type="checkbox" class="form-check-input" id="notification" name="notification"@if(context.settings.notification){ checked}/>
    <label class="form-check-label" for="notification">Send notifications</label>
  </div>
</fieldset>
<!--====================================================================-->
<!-- Web hook -->
<!--====================================================================-->
<hr>
<h5>Web hook</h5>
<fieldset>
  <div class="form-check">
    <input type="checkbox" class="form-check-input" id="blockPrivateAddress" name="webhook.blockPrivateAddress"@if(context.settings.webHook.blockPrivateAddress){ checked}/>
    <label class="form-check-label" for="blockPrivateAddress">Block sending to private addresses</label>
  </div>
</fieldset>
<div class="webhook">
  <label for="webhook.whitelist">IP whitelist</label>
  <fieldset>
    <textarea id="webhook.whitelist" name="webhook.whitelist" class="form-control" style="height: 100px;">@context.settings.webHook.whitelist.mkString("\n")</textarea>
  </fieldset>
</div>
<script>
$(function(){
  $('#sendTestMail').click(function(){
    var host        = $('#smtpHost'    ).val();
    var port        = $('#smtpPort'    ).val();
    var user        = $('#smtpUser'    ).val();
    var password    = $('#smtpPassword').val();
    var ssl         = $('#smtpSsl'     ).prop('checked');
    var starttls    = $('#smtpStarttls').prop('checked');
    var fromAddress = $('#fromAddress' ).val();
    var fromName    = $('#fromName'    ).val();
    var testAddress = $('#testAddress' ).val();

    if(host == ''){
      alert('SMTP Host is required.');
      $('#smtpHost').focus();
    } else if(testAddress == ''){
      alert('Destination is required.');
      $('#testAddress').focus();
    } else {
      $.post('@context.path/admin/system/sendmail', {
        'smtp.host': host,
        'smtp.port': port,
        'smtp.user': user,
        'smtp.password': password,
        'smtp.ssl': ssl,
        'smtp.starttls': starttls,
        'smtp.fromAddress': fromAddress,
        'smtp.fromName': fromName,
        'testAddress': testAddress
      }, function(data, status){
        if(data != ''){
          alert(data);
        }
      });
    }
  });

  $('#sshEnabled').change(function(){
    $('.ssh input').prop('disabled', !$(this).prop('checked'));
  }).change();

  $('#useSMTP').change(function(){
    $('.useSMTP input').prop('disabled', !$(this).prop('checked'));

    // With only SMTP in current version, notification cannot be enabled if no communication channel exists
    $('#notification').prop('disabled', !$(this).prop('checked'));

    if (!$(this).prop('checked')) {
      // With only SMTP in current version, if SMTP is unchecked then we disable notification
      $('#notification').prop('checked', false);
    }
  }).change();

  $('#blockPrivateAddress').change(function(){
    $('.webhook textarea').prop('disabled', !$(this).prop('checked'));
  }).change();
});
</script>
