@(tables: Seq[gitbucket.core.controller.Table])(implicit context: gitbucket.core.controller.Context)
@import gitbucket.core.view.helpers
@gitbucket.core.html.main("Database viewer") {
  @gitbucket.core.admin.html.menu("dbviewer") {
<div class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-6">
        <h1 class="m-0 text-dark"></h1>
      </div><!-- /.col -->
    </div><!-- /.row -->
  </div><!-- /.container-fluid -->
</div><!-- /.content-header -->
<div class="content body">
  <div class="container-fluid">
    <div class="row">
      <div class="col">
        <div class="card">
          <div class="card-header">
            <h4>Database viewer</h4>
          </div><!-- /.card-header -->
          <div class="card-body">
            <div class="row">
              <div class="col-md-3">
                <div id="table-tree">
                  <ul>
                    @tables.map { table =>
                    <li data-jstree='{"icon":"@context.path/assets/common/images/table.gif"}' data-table="@table.name">@table.name
                      <ul>
                        @table.columns.map { column =>
                        <li data-jstree='{"icon":"@context.path/assets/common/images/column.gif"}' data-table="@table.name" data-column="@column.name">
                          @column.name @if(column.primaryKey){ (PK) }
                        </li>
                        }
                      </ul>
                    </li>
                    }
                  </ul>
                </div><!-- /#table-tree -->
              </div><!-- /.col-md-3 -->
              <div class="col-md-9">
                <div id="editor" style="width: 100%; height: 300px;"></div>
                <div class="form-row my-1">
                  <div class="col-auto">
                    <input type="button" value="Run query" id="run-query" class="btn btn-success">
                  </div><!-- /.col-auto -->
                  <div class="col-auto">
                    <input type="button" value="Clear" id="clear-query" class="btn btn-default">
                  </div><!-- /.col-auto -->
                </div><!-- /.form-row -->
                <div class="row">
                  <div class="col">
                    <div class="form-check">
                      <input type="checkbox" class="form-check-input" id="autorun" name="autorun"/>
                      <label class="form-check-label" for="autorun">Auto Run Query</label>
                    </div><!-- /.form-check -->
                  </div><!-- /.col -->
                </div><!-- /.row -->
                <div class="row mt-3">
                  <div class="col" style="overflow:auto;">
                    <div id="result"></div>
                  </div><!-- /.col -->
                </div><!-- /.row -->
              </div><!-- /.col-md-9 -->
            </div><!-- /.row -->
          </div><!-- /.card-body"-->
        </div><!-- /.card -->
      </div><!-- /.col -->
    </div><!-- /.row -->
  </div><!-- /container -->
</div><!-- /.content-body -->
  }
}
<script src="@helpers.assets("/vendors/ace/ace.js")" type="text/javascript" charset="utf-8"></script>
<script src="@helpers.assets("/vendors/vakata-jstree-3.3.4/jstree.min.js")" type="text/javascript" charset="utf-8"></script>
<link rel="stylesheet" href="@helpers.assets("/vendors/vakata-jstree-3.3.4/themes/default/style.min.css")" />
<script>
function getPosition(editor, position){
  var session = editor.getSession();
  var result = 0;
  for(var i = 0; i < position.row; i++){
    result = result + session.getLine(i).length + 1;
  }
  return result + position.column;
}

$(function(){
  $('#editor').text($('#initial').val());
  var editor = ace.edit("editor");
  editor.setTheme("ace/theme/monokai");
  editor.getSession().setMode("ace/mode/sql");

  $('#table-tree').jstree();

  $('#table-tree').on('select_node.jstree', function(e, data){
    if(editor.getValue().trim() == '' || $('#autorun').is(':checked')){
      if(data.node.data['column']){
        editor.setValue('SELECT ' + data.node.data['column'] + ' FROM ' + data.node.data['table']);
      } else if(data.node.data['table']){
        editor.setValue('SELECT * FROM ' + data.node.data['table']);
      }
      if($('#autorun').is(':checked')){
        $('#run-query').click();
      }
    } else {
      var position = editor.getCursorPosition();
      var prefix = '';
      // Check a previous character
      if(position.column != 0){
        var range = new ace.Range(position.row, position.column - 1, position.row, position.column);
        var c = editor.getSession().getTextRange(range);
        if(c != '' && c != ' ' && c != '.' && c != ',' && c != '\t' && c != '\r' && c != '\n'){
          prefix = ', ';
        }
      }
      if(data.node.data['column']){
        editor.getSession().insert(position, prefix + data.node.data['column']);
      } else if(data.node.data['table']){
        editor.getSession().insert(position, prefix + data.node.data['table']);
      }
    }
    editor.focus();
  });

  $('#clear-query').click(function(){
    editor.setValue('');
  });

  $('#run-query').click(function(){
    var selectedText = editor.getSession().doc.getTextRange(editor.selection.getRange()).trim();

    $.post('@context.path/admin/dbviewer/_query', { query: selectedText == '' ? editor.getValue() : selectedText },
      function(data){
        if(data.type == "query"){
          var table = $('<table class="table table-bordered table-hover table-scroll">');

          var header = $('<tr>');
          $.each(data.columns, function(i, column){
            header.append($('<th>').text(column));
          });
          table.append($('<thead>').append(header));

          var body = $('<tbody>');
          $.each(data.rows, function(i, rs){
            var row = $('<tr>');
            $.each(data.columns, function(i, column){
              row.append($('<td>').text(rs[column]));
            });
            body.append(row);
          });

          table.append(body);
          $('#result').empty().append(table);

        } else if(data.type == "update"){
          $('#result').empty().append($('<span>').text('Updated ' + data.rows + ' rows.'));

        } else if(data.type == "error"){
          $('#result').empty().append($('<span class="error">').text(data.message));
        }
      }
    );
  });
});
</script>
