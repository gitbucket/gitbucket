@(repository: gitbucket.core.service.RepositoryService.RepositoryInfo,
  branch: String,
  protection: gitbucket.core.api.ApiBranchProtection,
  knownContexts: Seq[String],
  info: Option[Any])(implicit context: gitbucket.core.controller.Context)
@import gitbucket.core.view.helpers
@check(bool:Boolean)={@if(bool){ checked}}
@gitbucket.core.html.main(s"Branch protection for ${branch}", Some(repository)){
  @gitbucket.core.html.menu("settings", repository){
    @gitbucket.core.settings.html.menu("branches", repository){
    <form name="branchProtection" onsubmit="submitForm(event)">
    <div class="card-body">
      @gitbucket.core.helper.html.information(info)
      <div class="alert alert-info" style="display:none" id="saved-info">Branch protection options saved</div>
        <h3 class="panel-heading">Branch protection for <b>@branch</b></h3>
        <div>
          <div class="form-group">
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="enabled" id="enabled" onclick="update()" @check(protection.enabled)>
              <label class="form-check-label" for="enabled">Protect this branch</label>
              <p class="help-block text-muted small">Disables force-pushes to this branch and prevents it from being deleted.</p>
            </div>
          </div>
          <div class="form-group js-enabled" style="display:none">
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="has_required_statuses" id="has_required_statuses" onclick="update()" @check(protection.status.enforcement_level.name!="off") @if(knownContexts.isEmpty){disabled }>
              <label class="form-check-label" for="has_required_statuses">Require status checks to pass before merging</label>
              <p class="help-block text-muted small">When enabled, commits must first be pushed to another branch, then merged or pushed directly to <b>@branch</b> after status checks have passed.</p>
            </div>
            @if( knownContexts.isEmpty ){
              <div class="alert alert-warning">
                Sorry, we couldnâ€™t find any status checks in the last week for this repository.<br />
                Please create a commit status by API (<a href="https://developer.github.com/v3/repos/statuses/">Learn more about status checks on GitHub</a>)
              </div>
            } else {
              <div class="js-has_required_statuses" style="display:none">
                <h3>Choose which status checks must pass before branches can be merged into <b>@branch</b>.</h3>
                <div class="form-group">
                  @knownContexts.map { context =>
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input" name="contexts" value="@context" id="context-@context" onclick="update()" @check(protection.status.contexts.find(_ == context))>
                    <label class="form-check-label" for="context-@context">@context</label>
                  </div>
                  }
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input" name="enforce_for_admins" id="enforce_for_admins" onclick="update()" @check(protection.status.enforcement_level.name=="everyone")>
                    <label class="form-check-label" for="enforce_for_admins">Include administrators</label>
                    <p class="help-block">Enforce required status checks for repository administrators.</p>
                  </div>
                </div>
              </div>
            }
          </div>
        </div>
      </div>
      <div class="card-footer">
        <div class="float-right">
          <input class="btn btn-success js-submit-btn" type="submit" value="Save changes" />
        </div>
      </div>
    </form>
    }
  }
}
<script>
function getValue(){
  var v = {}, contexts=[];
  $("input[type=checkbox]:checked").each(function(){
    if(this.name === 'contexts'){
      contexts.push(this.value);
    } else {
      v[this.name] = true;
    }
  });
  if(v.enabled){
    return {
      enabled: true,
      required_status_checks: {
        enforcement_level: v.has_required_statuses ? ((v.enforce_for_admins ? 'everyone' : 'non_admins')) : 'off',
        contexts: v.has_required_statuses ? contexts : []
      }
    };
  } else {
    return {
      enabled: false,
      required_status_checks: {
        enforcement_level: "off",
        contexts: []
      }
    };
  }
}
function updateView(protection){
  $('.js-enabled').toggle(protection.enabled);
  $('.js-has_required_statuses').toggle(protection.required_status_checks.enforcement_level != 'off');
  $('.js-submit-btn').attr('disabled',protection.required_status_checks.enforcement_level != 'off' && protection.required_status_checks.contexts.length == 0);
}
function update(){
  var protection = getValue();
  updateView(protection);
}
$(update);
function submitForm(e){
  e.stopPropagation();
  e.preventDefault();
  var protection = getValue();
  $.ajax({
    method:'PATCH',
    url:'@context.path/api/v3/repos/@repository.owner/@repository.name/branches/@helpers.urlEncode(branch)',
    contentType: 'application/json',
    dataType: 'json',
    data:JSON.stringify({protection:protection}),
    success:function(r){
      $('#saved-info').show();
    },
    error:function(err){
      console.log(err);
      alert('update error');
    }
  });
}
</script>
