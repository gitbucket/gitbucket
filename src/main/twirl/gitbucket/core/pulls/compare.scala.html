@(title: String,
  commits: Seq[Seq[gitbucket.core.util.JGitUtil.CommitInfo]],
  diffs: Seq[gitbucket.core.util.JGitUtil.DiffInfo],
  members: List[(String, String, String)],
  comments: List[gitbucket.core.model.Comment],
  originId: String,
  forkedId: String,
  sourceId: String,
  commitId: String,
  content: String,
  repository: gitbucket.core.service.RepositoryService.RepositoryInfo,
  originRepository: gitbucket.core.service.RepositoryService.RepositoryInfo,
  forkedRepository: gitbucket.core.service.RepositoryService.RepositoryInfo,
  hasOriginWritePermission: Boolean,
  collaborators: List[String],
  milestones: List[gitbucket.core.model.Milestone],
  priorities: List[gitbucket.core.model.Priority],
  defaultPriority: Option[gitbucket.core.model.Priority],
  labels: List[gitbucket.core.model.Label])(implicit context: gitbucket.core.controller.Context)
@import gitbucket.core.view.helpers
@gitbucket.core.html.main(s"Pull requests - ${repository.owner}/${repository.name}", Some(repository)){
  @gitbucket.core.html.menu("pulls", repository){
<div class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-6">
        <h1 class="m-0 text-dark"></h1>
      </div><!-- /.col -->
    </div><!-- /.row -->
  </div><!-- /.container-fluid -->
</div><!-- /.content-header -->
<div class="content body">
  <div class="container-fluid">
    <div class="row">
      <div class="col">
        <div class="card">
          <div class="card-header">
            <h4>Pull request</h4>
          </div><!-- /.card-header -->
          <div class="card-body">
            <div class="container mb-4">
              <div class="border rounded-sm my-2 p-2 bg-light">
                <div id="compare-edit">
                  <div class="row">
                    <div class="col-sm-auto">
                      @gitbucket.core.helper.html.dropdown(originRepository.owner + "/" + originRepository.name, "base fork", filter=("origin_repo", "Find Repository...")) {
                      @members.map { case (owner, name, defaultBranch) =>
                      <a href="#" class="dropdown-item origin-owner" data-owner="@owner" data-name="@name" data-default-branch="@defaultBranch">@gitbucket.core.helper.html.checkicon(owner == originRepository.owner) @owner/@name</a>
                      }
                      }
                      @gitbucket.core.helper.html.dropdown(originId, "base", filter=("origin_branch", "Find Branch...")) {
                      @if(!originRepository.branchList.contains(originId)){
                      <a href="#" class="dropdown-item origin-branch" data-branch="@helpers.encodeRefName(originId)">@gitbucket.core.helper.html.checkicon(true) @originId</a>
                      }
                      @originRepository.branchList.map { branch =>
                      <a href="#" class="dropdown-item origin-branch" data-branch="@helpers.encodeRefName(branch)">@gitbucket.core.helper.html.checkicon(branch == originId) @branch</a>
                      }
                      }
                    </div><!-- .col -->
                    <div class="col-sm-auto">
                      ...
                    </div><!-- .col -->
                    <div class="col-sm-auto">
                      @gitbucket.core.helper.html.dropdown(forkedRepository.owner + "/" + forkedRepository.name, "head fork", filter=("forked_repo", "Find Repository...")) {
                      @members.map { case (owner, name, defaultBranch) =>
                      <a href="#" class="dropdown-item forked-owner" data-owner="@owner" data-name="@name" data-default-branch="@defaultBranch">@gitbucket.core.helper.html.checkicon(owner == forkedRepository.owner) @owner/@name</a>
                      }
                      }
                      @gitbucket.core.helper.html.dropdown(forkedId, "compare", filter=("forked_branch", "Find Branch...")) {
                      @if(!forkedRepository.branchList.contains(forkedId)){
                      <a href="#" class="dropdown-item origin-branch" data-branch="@helpers.encodeRefName(forkedId)">@gitbucket.core.helper.html.checkicon(true) @forkedId</a>
                      }
                      @forkedRepository.branchList.map { branch =>
                      <a href="#" class="dropdown-item forked-branch" data-branch="@helpers.encodeRefName(branch)">@gitbucket.core.helper.html.checkicon(branch == forkedId) @branch</a>
                      }
                      }
                    </div><!-- .col -->
                  </div><!-- .row -->
                 </div>
                @if(originRepository.branchList.contains(originId) && forkedRepository.branchList.contains(forkedId)){
                <div class="check-conflict" style="display: none;">
                  <img src="@helpers.assets("/common/images/indicator.gif")"/> Checking...
                </div>
                }
              </div><!-- .border -->
              @if(commits.nonEmpty && context.loginAccount.isDefined && originRepository.branchList.contains(originId) && forkedRepository.branchList.contains(forkedId)){
              <div class="create-pullreq border rounded-sm my-2 p-2" id="create-pull-request">
                <div class="row">
                  <div class="col-sm-auto">
                    <a href="#" class="btn btn-success" id="show-form">Create pull request</a>
                  </div><!-- .col -->
                  <div class="col align-self-center">
                    <span class="text-muted">Discuss and review the changes in this comparison with others.</span>
                  </div><!-- .col -->
                </div><!-- .row -->
              </div><!-- .create-pullreq -->
              <div class="my-4" id="pull-request-form" style="display: none;">
                <form method="POST" action="@context.path/@originRepository.owner/@originRepository.name/pulls/new" validate="true">
                  <div class="row">
                    <div class="col-md-9">
                      <span class="error" id="error-title"></span>
                      <input type="text" name="title" value="@title" class="form-control mb-3" placeholder="Title"/>
                      @gitbucket.core.helper.html.preview(
                      repository         = repository,
                      content            = content,
                      enableWikiLink     = false,
                      enableRefsLink     = true,
                      enableLineBreaks   = true,
                      enableTaskList     = true,
                      hasWritePermission = true,
                      completionContext  = "issues",
                      style              = "height: 200px;"
                      )
                      <div class="text-right">
                        <input type="hidden" name="targetUserName" value="@originRepository.owner"/>
                        <input type="hidden" name="targetBranch" value="@originId"/>
                        <input type="hidden" name="requestUserName" value="@forkedRepository.owner"/>
                        <input type="hidden" name="requestRepositoryName" value="@forkedRepository.name"/>
                        <input type="hidden" name="requestBranch" value="@forkedId"/>
                        <input type="hidden" name="commitIdFrom" value="@sourceId"/>
                        <input type="hidden" name="commitIdTo" value="@commitId"/>
                        <input type="hidden" id="is-draft" name="isDraft" value=false />
                        <div class="btn-group dropdown">
                          <input type="submit" class="btn btn-success" tabindex="2" value="Create pull request" id="submit-button" validate="true" formaction="@context.path/@originRepository.owner/@originRepository.name/pulls/new"/>
                          <button type="button" class="btn btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span class="caret"></span>
                          </button>
                          <div class="dropdown-menu dropdown-menu-right">
                            <a class="dropdown-item" id="pull-request">Create pull request</a>
                            <a class="dropdown-item" id="draft-request">Create draft request</a>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      @gitbucket.core.issues.html.issueinfo(None, Nil, Nil, collaborators, milestones.map((_, 0, 0)), priorities, defaultPriority, labels, hasOriginWritePermission, repository)
                    </div>
                  </div>
                </form>
              </div>
              }
              @if(commits.isEmpty){
              <div class="border rounded-sm text-center bg-light p-2 my-2">
                <h4>There isn't anything to compare.</h4>
                <span class="font-weight-bold">@originRepository.owner:@originId</span> and <span class="font-weight-bold">@forkedRepository.owner:@forkedId</span> are identical.
              </div>
              } else {
              <div class="border rounded-sm my-2 p-2">
                <div class="row">
                  <div class="col-sm text-sm-center">
                    <i class="octicon octicon-git-commit"></i>
                    @defining(commits.flatten){ commits =>
                    <strong>@commits.size</strong> @helpers.plural(commits.size, "commit")
                    }
                  </div>
                  <div class="col-sm text-sm-center">
                    <i class="octicon octicon-diff"></i>
                    <strong>@diffs.size</strong> @helpers.plural(diffs.size, "file") changed
                  </div>
                  <div class="col-sm text-sm-center">
                    <i class="octicon octicon-comment"></i>
                    @defining(comments.collect { case c: gitbucket.core.model.CommitComment => c }){ comments =>
                    <strong>@comments.size</strong> commit @helpers.plural(comments.size, "comment")
                    }
                  </div>
                  <div class="col-sm text-sm-center">
                    <i class="octicon octicon-organization"></i>
                    @defining(commits.flatMap(_.map(_.authorEmailAddress)).distinct){ contributors =>
                    <strong>@contributors.size</strong> @helpers.plural(contributors.size, "contributor")
                    }
                  </div>
                </div><!-- .row -->
              </div><!-- .border -->
              <div class="my-2">
                @commits.map { day =>
                <div class="mt-3 mb-1 text-muted">
                  Commits on @helpers.date(day.head.commitTime)
                </div>
                <div>
                  @day.map { commit =>
                  <div class="row mb-1">
                    <div class="col-sm">
                      <i class="octicon octicon-git-commit"></i>
                      @helpers.avatarLink(commit, 20)
                      @helpers.user(commit.authorName, commit.authorEmailAddress, "username font-weight-bold")
                    </div>
                    <div class="col-sm">
                      <span class="monospace">@commit.shortMessage</span>
                    </div>
                    <div class="col-sm">
                      <a href="@helpers.url(repository)/commit/@commit.id" class="float-sm-right monospace">@commit.id.substring(0, 7)</a>
                    </div>
                  </div><!-- .row -->
                  }
                </div>
                }
              </div>
            </div><!-- .container -->
            @gitbucket.core.helper.html.diff(diffs, repository, Some(commitId), Some(sourceId), true, None, false, false)
            @gitbucket.core.issues.html.commentlist(None, comments, false, repository, None)
          </div><!-- /.card-body"-->
        </div><!-- /.card -->
      </div><!-- /.col -->
    </div><!-- /.row -->
  </div><!-- /container -->
</div><!-- /.content-body -->

    }
  }
}
<script>

$(function(){
  $('#draft-request').click(function(){
    $("#is-draft").val(true);
    $('#submit-button').attr('value', 'Create draft request')
  });
  $('#pull-request').click(function(){
  $("#is-draft").val(false);
    $('#submit-button').attr('value', 'Create pull request')
  });
});


$(function(){
  function updateSelector(e){
    e.parents('.dropdown-menu').find('i').attr('class', 'octicon');
    e.find('i').addClass('octicon-check');
    e.parents('div.btn-group').find('button span.font-weight-bold').text(e.text());
  }

  $('a.origin-owner').click(function(){
    updateSelector($(this));

    location.href = '@context.path/' +
      $.trim($('i.octicon-check').parents('a.forked-owner' ).data('owner')) + '/' +
      $.trim($('i.octicon-check').parents('a.forked-owner' ).data('name')) +'/compare/' +
      $.trim($('i.octicon-check').parents('a.origin-owner' ).data('owner')) + ':' +
      $.trim($('i.octicon-check').parents('a.origin-owner' ).data('default-branch')) + '...' +
      $.trim($('i.octicon-check').parents('a.forked-owner' ).data('owner')) + ':' +
      $.trim($('i.octicon-check').parents('a.forked-branch').data('branch'));
  });

  $('a.forked-owner').click(function(){
    updateSelector($(this));

    location.href = '@context.path/' +
      $.trim($('i.octicon-check').parents('a.forked-owner' ).data('owner')) + '/' +
      $.trim($('i.octicon-check').parents('a.forked-owner' ).data('name')) +'/compare/' +
      $.trim($('i.octicon-check').parents('a.origin-owner' ).data('owner')) + ':' +
      $.trim($('i.octicon-check').parents('a.origin-branch').data('branch')) + '...' +
      $.trim($('i.octicon-check').parents('a.forked-owner' ).data('owner')) + ':' +
      $.trim($('i.octicon-check').parents('a.forked-owner' ).data('default-branch'));
  });

  $('a.origin-branch, a.forked-branch').click(function(){
    updateSelector($(this));

    location.href = '@context.path/' +
      $.trim($('i.octicon-check').parents('a.forked-owner' ).data('owner')) + '/' +
      $.trim($('i.octicon-check').parents('a.forked-owner' ).data('name')) +'/compare/' +
      $.trim($('i.octicon-check').parents('a.origin-owner' ).data('owner')) + ':' +
      $.trim($('i.octicon-check').parents('a.origin-branch').data('branch')) + '...' +
      $.trim($('i.octicon-check').parents('a.forked-owner' ).data('owner')) + ':' +
      $.trim($('i.octicon-check').parents('a.forked-branch').data('branch'));
  });

  $('#show-form').click(function(){
    $('#create-pull-request').hide();
    $('#pull-request-form').show();
  });
  if(location.search.substr(1).split("&").indexOf("expand=1")!=-1){
    $('#show-form').click();
  }

  @if(context.loginAccount.isDefined && originRepository.branchList.contains(originId) && forkedRepository.branchList.contains(forkedId)){
    function checkConflict(from, to){
      $('.check-conflict').show();
      $.get('@helpers.url(forkedRepository)/compare/' + from + '...' + to + '/mergecheck',
        function(data){ $('.check-conflict').html(data); });
    }

    checkConflict(
      $.trim($('i.octicon-check').parents('a.origin-owner' ).data('owner')) + ":" +
      $.trim($('i.octicon-check').parents('a.origin-branch').data('branch')),
      $.trim($('i.octicon-check').parents('a.forked-owner' ).data('owner')) + ":" +
      $.trim($('i.octicon-check').parents('a.forked-branch').data('branch'))
    );
  }
});
</script>
